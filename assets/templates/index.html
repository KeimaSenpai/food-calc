<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Calculator - Calculador Moderno</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        glass: 'rgba(255, 255, 255, 0.05)',
                        glassHover: 'rgba(255, 255, 255, 0.1)',
                        glassBorder: 'rgba(255, 255, 255, 0.1)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Spinner actualizado para fondo oscuro */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #111827; 
        }
        ::-webkit-scrollbar-thumb {
            background: #374151; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4b5563; 
        }

        /* Glass Utility */
        .glass-panel {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
    </style>
</head>
<body class="bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-gray-800 via-gray-900 to-black min-h-screen text-gray-200 selection:bg-blue-500 selection:text-white">
    
    <div class="fixed top-0 left-0 w-96 h-96 bg-blue-600/20 rounded-full blur-[100px] -z-10"></div>
    <div class="fixed bottom-0 right-0 w-96 h-96 bg-purple-600/10 rounded-full blur-[100px] -z-10"></div>

    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <div class="text-center mb-12 fade-in">
            <h1 class="text-5xl md:text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-400 mb-3 tracking-tight">
                Food Calculator
            </h1>
            <p class="text-gray-400 text-lg font-light">Calcula las cantidades exactas con precisi√≥n profesional</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-1">
                <div class="glass-panel rounded-2xl p-6 sticky top-8 fade-in">
                    <div class="flex items-center gap-2 mb-6 border-b border-white/10 pb-4">
                        <span class="text-2xl">‚öôÔ∏è</span>
                        <h2 class="text-xl font-bold text-white">Configuraci√≥n</h2>
                    </div>
                    
                    <div class="mb-6">
                        <label for="personas" class="block text-gray-300 font-medium mb-2 text-sm uppercase tracking-wider">
                            N√∫mero de Personas
                        </label>
                        <div class="relative">
                            <input 
                                type="number" 
                                id="personas" 
                                value="50" 
                                min="1" 
                                max="1000"
                                class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-all text-lg font-semibold"
                            >
                        </div>
                        <input 
                            type="range" 
                            id="rangoPersonas" 
                            value="50" 
                            min="1" 
                            max="500"
                            class="w-full mt-4 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500"
                        >
                        <p class="text-xs text-gray-500 mt-2 text-right font-mono">1 - 500 personas</p>
                    </div>

                    <div class="mb-8">
                        <label for="formato" class="block text-gray-300 font-medium mb-2 text-sm uppercase tracking-wider">
                            Formato de Salida
                        </label>
                        <div class="relative">
                            <select 
                                id="formato"
                                class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50 appearance-none cursor-pointer"
                            >
                                <option value="tabla" class="bg-gray-800 text-white">Tabla interactiva</option>
                                <option value="texto" class="bg-gray-800 text-white">Texto plano</option>
                                <option value="markdown" class="bg-gray-800 text-white">Markdown (Telegram)</option>
                                <option value="lista" class="bg-gray-800 text-white">Lista JSON</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-400">
                                <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                            </div>
                        </div>
                    </div>

                    <div class="mb-8">
                        <label for="preparacion" class="block text-gray-300 font-medium mb-2 text-sm uppercase tracking-wider">
                            üç≥ Selecciona Plato
                        </label>
                        <div class="relative">
                            <select 
                                id="preparacion"
                                class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50 appearance-none cursor-pointer"
                            >
                                <option value="" class="bg-gray-800 text-white">-- Selecciona un plato --</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-400">
                                <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <button 
                            onclick="calcular()"
                            class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-3 px-4 rounded-xl transition duration-300 shadow-lg shadow-blue-900/20 transform hover:-translate-y-0.5"
                        >
                            üìä Calcular Cantidades
                        </button>
                        <button 
                            onclick="calcularPreparacion()"
                            class="w-full bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white font-bold py-3 px-4 rounded-xl transition duration-300 shadow-lg shadow-orange-900/20 transform hover:-translate-y-0.5"
                        >
                            üç≥ Calcular Plato
                        </button>
                        <button 
                            onclick="calcularRefresco()"
                            class="w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold py-3 px-4 rounded-xl transition duration-300 shadow-lg shadow-cyan-900/20 transform hover:-translate-y-0.5"
                        >
                            ü•§ Calcular Refresco
                        </button>
                        <button 
                            onclick="obtenerIngredientes()"
                            class="w-full bg-white/5 hover:bg-white/10 border border-white/10 text-emerald-400 font-semibold py-3 px-4 rounded-xl transition duration-300 hover:text-emerald-300"
                        >
                            üë®‚Äçüç≥ Ver Ingredientes
                        </button>
                        <div class="flex gap-2">
                            <button 
                                onclick="mostrarOpcionesDescarga()"
                                class="flex-1 bg-purple-600/80 hover:bg-purple-600 text-white font-semibold py-3 px-4 rounded-xl transition duration-300 backdrop-blur-sm"
                                id="btnDescargar"
                                style="display: none;"
                            >
                                ‚¨áÔ∏è Descargar
                            </button>
                            <button 
                                onclick="copiarAlPortapapeles()"
                                class="flex-1 bg-gray-700/50 hover:bg-gray-600/50 text-white font-semibold py-3 px-4 rounded-xl transition duration-300 backdrop-blur-sm"
                                id="btnCopiar"
                                style="display: none;"
                            >
                                üìã Copiar
                            </button>
                        </div>
                    </div>

                    <div class="mt-8 pt-8 border-t border-white/10">
                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">üîç B√∫squeda R√°pida</h3>
                        <div class="relative">
                            <input 
                                type="text"
                                id="buscarProducto"
                                placeholder="Ej: Arroz, Pollo..."
                                class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-2 pl-10 text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50"
                                onkeyup="buscarProductos()"
                            >
                            <span class="absolute left-3 top-2.5 text-gray-500">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                            </span>
                        </div>
                        <div id="resultadosBusqueda" class="mt-3 space-y-1"></div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="flex p-1 bg-black/40 backdrop-blur-md rounded-xl mb-6 border border-white/5 overflow-x-auto">
                    <button 
                        class="tab-btn flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all duration-200 whitespace-nowrap active-tab"
                        data-tab="resultados"
                        onclick="cambiarTab('resultados')"
                    >
                        üì¶ Productos
                    </button>
                    <button 
                        class="tab-btn flex-1 py-2 px-4 rounded-lg text-sm font-medium text-gray-400 hover:text-white transition-all duration-200 whitespace-nowrap"
                        data-tab="ingredientes"
                        onclick="cambiarTab('ingredientes')"
                    >
                        ü•ò Preparaciones
                    </button>
                    <button 
                        class="tab-btn flex-1 py-2 px-4 rounded-lg text-sm font-medium text-gray-400 hover:text-white transition-all duration-200 whitespace-nowrap"
                        data-tab="info"
                        onclick="cambiarTab('info')"
                    >
                        ‚ÑπÔ∏è Info
                    </button>
                </div>

                <div class="glass-panel rounded-2xl p-6 min-h-[500px] relative overflow-hidden">
                    
                    <div id="tab-resultados" class="tab-content fade-in h-full">
                        <div id="contenidoResultados" class="h-full">
                            <div class="flex flex-col items-center justify-center h-full text-gray-500 py-12">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-4 opacity-20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                </svg>
                                <p class="text-lg font-light">Ingresa personas y pulsa "Calcular"</p>
                            </div>
                        </div>
                    </div>

                    <div id="tab-ingredientes" class="tab-content hidden h-full">
                        <div id="contenidoIngredientes" class="h-full">
                            <div class="flex flex-col items-center justify-center h-full text-gray-500 py-12">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-4 opacity-20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                                </svg>
                                <p class="text-lg font-light">Haz clic en "Ingredientes" para ver detalles</p>
                            </div>
                        </div>
                    </div>

                    <div id="tab-info" class="tab-content hidden">
                        <div class="space-y-6 text-gray-300">
                            <div>
                                <h3 class="text-2xl font-bold text-white mb-2">üìñ Sobre Food Calculator</h3>
                                <p class="leading-relaxed">
                                    Una herramienta de precisi√≥n dise√±ada para optimizar la planificaci√≥n de eventos gastron√≥micos, calculando las materias primas necesarias bas√°ndose en el n√∫mero de comensales.
                                </p>
                            </div>
                            
                            <div class="grid md:grid-cols-2 gap-6">
                                <div>
                                    <h4 class="text-lg font-bold text-blue-400 mb-3 flex items-center gap-2">
                                        <span>‚ú®</span> Caracter√≠sticas
                                    </h4>
                                    <ul class="space-y-2 text-sm">
                                        <li class="flex items-center gap-2"><span class="w-1.5 h-1.5 bg-blue-500 rounded-full"></span>C√°lculo exacto (kg/unidades)</li>
                                        <li class="flex items-center gap-2"><span class="w-1.5 h-1.5 bg-blue-500 rounded-full"></span>+40 Productos base</li>
                                        <li class="flex items-center gap-2"><span class="w-1.5 h-1.5 bg-blue-500 rounded-full"></span>Desglose de preparaciones</li>
                                        <li class="flex items-center gap-2"><span class="w-1.5 h-1.5 bg-blue-500 rounded-full"></span>Exportaci√≥n Multi-formato</li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 class="text-lg font-bold text-emerald-400 mb-3 flex items-center gap-2">
                                        <span>üì¶</span> Inventario
                                    </h4>
                                    <ul class="grid grid-cols-2 gap-2 text-sm">
                                        <li>üçö Arroces</li>
                                        <li>üçñ Carnes</li>
                                        <li>üêü Pescado</li>
                                        <li>üçù Pastas</li>
                                        <li>ü•ó Vegetales</li>
                                        <li>üßÄ L√°cteos</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="bg-yellow-900/20 border border-yellow-700/50 rounded-xl p-4 mt-6">
                                <div class="flex gap-3">
                                    <span class="text-2xl">üìù</span>
                                    <div>
                                        <h5 class="font-bold text-yellow-500">Nota Importante</h5>
                                        <p class="text-sm text-yellow-200/80 mt-1">
                                            Todas las cantidades se calculan sobre productos crudos (peso bruto). 
                                            Los valores finales pueden variar seg√∫n mermas y m√©todos de cocci√≥n.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div id="modalResultados" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 transition-all duration-300">
        <div class="bg-gray-900 border border-white/10 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[80vh] flex flex-col">
            <div class="p-5 border-b border-white/10 flex justify-between items-center bg-gray-900/50 rounded-t-2xl">
                <h2 class="text-xl font-bold text-white">Resultados Generados</h2>
                <button onclick="cerrarModal()" class="text-gray-400 hover:text-white transition rounded-lg p-1 hover:bg-white/10">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-6 overflow-auto custom-scrollbar flex-grow bg-gray-950">
                <pre id="contenidoModal" class="whitespace-pre-wrap text-sm font-mono text-gray-300"></pre>
            </div>
            <div class="p-5 border-t border-white/10 flex gap-3 bg-gray-900 rounded-b-2xl">
                <button onclick="copiarContenidoModal()" class="flex-1 bg-blue-600/20 hover:bg-blue-600/30 text-blue-400 border border-blue-500/50 font-bold py-2 px-4 rounded-xl transition">
                    üìã Copiar
                </button>
                <button onclick="descargarContenidoModal()" class="flex-1 bg-emerald-600/20 hover:bg-emerald-600/30 text-emerald-400 border border-emerald-500/50 font-bold py-2 px-4 rounded-xl transition">
                    ‚¨áÔ∏è Guardar TXT
                </button>
                <button onclick="cerrarModal()" class="flex-1 bg-gray-700/50 hover:bg-gray-600/50 text-white font-bold py-2 px-4 rounded-xl transition">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <div id="modalDescarga" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gray-900 border border-white/10 rounded-2xl shadow-2xl max-w-md w-full">
            <div class="p-5 border-b border-white/10 flex justify-between items-center">
                <h2 class="text-xl font-bold text-white">‚¨áÔ∏è Opciones de Exportaci√≥n</h2>
                <button onclick="cerrarModalDescarga()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="p-6 space-y-3">
                <button onclick="descargarPDF()" class="w-full bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/50 font-bold py-3 px-4 rounded-xl transition flex items-center justify-center gap-2 group">
                    <span class="group-hover:scale-110 transition-transform">üìÑ</span> PDF Document
                </button>
                <button onclick="descargarImagen()" class="w-full bg-yellow-500/10 hover:bg-yellow-500/20 text-yellow-400 border border-yellow-500/50 font-bold py-3 px-4 rounded-xl transition flex items-center justify-center gap-2 group">
                    <span class="group-hover:scale-110 transition-transform">üñºÔ∏è</span> Imagen PNG
                </button>
                <button onclick="descargarTXT()" class="w-full bg-blue-500/10 hover:bg-blue-500/20 text-blue-400 border border-blue-500/50 font-bold py-3 px-4 rounded-xl transition flex items-center justify-center gap-2 group">
                    <span class="group-hover:scale-110 transition-transform">üìù</span> Archivo Texto
                </button>
                <div class="pt-2">
                    <button onclick="cerrarModalDescarga()" class="w-full bg-transparent hover:bg-white/5 text-gray-400 font-semibold py-2 px-4 rounded-xl transition">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Estado global
        let estadoActual = {
            personas: 50,
            formato: 'tabla',
            resultados: null,
            ingredientes: null,
            contenidoActual: null
        };

        // Sincronizar input y rango
        document.getElementById('personas').addEventListener('change', function() {
            document.getElementById('rangoPersonas').value = this.value;
        });

        document.getElementById('rangoPersonas').addEventListener('input', function() {
            document.getElementById('personas').value = this.value;
        });

        document.getElementById('formato').addEventListener('change', function() {
            estadoActual.formato = this.value;
        });

        // Funciones principales
        async function calcular() {
            const personas = parseInt(document.getElementById('personas').value);
            const formato = document.getElementById('formato').value;
            
            if (isNaN(personas) || personas < 1) {
                alert('Por favor ingresa un n√∫mero v√°lido de personas');
                return;
            }

            mostrarCargando();

            try {
                const response = await fetch('/api/calcular', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ personas })
                });

                const data = await response.json();

                if (!data.success) {
                    alert('Error: ' + data.error);
                    return;
                }

                estadoActual.resultados = data;
                estadoActual.personas = personas;

                if (formato === 'tabla') {
                    mostrarResultadosTabla(data);
                } else {
                    await obtenerFormatoEspecial(formato, personas);
                }

                document.getElementById('btnDescargar').style.display = 'block';
                document.getElementById('btnCopiar').style.display = 'block';
                cambiarTab('resultados');

            } catch (error) {
                console.error('Error:', error);
                alert('Error al calcular: ' + error.message);
            }
        }

        function mostrarResultadosTabla(data) {
            const productos_kg = data.productos_kg || {};
            const productos_unidades = data.productos_unidades || {};
            
            // NOTA: Estilos actualizados a Dark Mode dentro del JS string
            let html = `<div class="mb-6 fade-in">
                <div class="flex justify-between items-end mb-6 border-b border-white/10 pb-4">
                    <div>
                        <h3 class="text-2xl font-bold text-white">
                            Resultados del C√°lculo
                        </h3>
                        <p class="text-sm text-gray-400 mt-1">Para un total de <span class="text-blue-400 font-bold">${data.personas} personas</span></p>
                    </div>
                    <span class="text-xs bg-gray-800 text-gray-400 px-2 py-1 rounded border border-gray-700">Crudo / Bruto</span>
                </div>`;

            // Mostrar productos en kg
            if (Object.keys(productos_kg).length > 0) {
                html += '<h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">‚öñÔ∏è Por Peso (Kg)</h4>';
                html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">';
                
                for (const [producto, cantidad] of Object.entries(productos_kg)) {
                    html += `<div class="bg-blue-900/10 border border-blue-500/20 hover:border-blue-500/40 rounded-xl p-4 flex justify-between items-center transition-all group">
                        <span class="font-medium text-gray-200 group-hover:text-white">${producto}</span>
                        <span class="font-bold text-blue-400 text-lg">${cantidad} <span class="text-sm text-blue-500/70">kg</span></span>
                    </div>`;
                }
                html += '</div>';
            }

            // Mostrar productos por unidades
            if (Object.keys(productos_unidades).length > 0) {
                html += '<h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">üì¶ Por Unidades</h4>';
                html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                
                for (const [producto, cantidad] of Object.entries(productos_unidades)) {
                    html += `<div class="bg-emerald-900/10 border border-emerald-500/20 hover:border-emerald-500/40 rounded-xl p-4 flex justify-between items-center transition-all group">
                        <span class="font-medium text-gray-200 group-hover:text-white">${producto}</span>
                        <span class="font-bold text-emerald-400 text-lg">${cantidad} <span class="text-sm text-emerald-500/70">ud</span></span>
                    </div>`;
                }
                html += '</div>';
            }

            html += '</div>';
            document.getElementById('contenidoResultados').innerHTML = html;
            estadoActual.contenidoActual = data;
        }

        async function obtenerFormatoEspecial(formato, personas) {
            try {
                const response = await fetch(`/api/formato/${formato}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ personas })
                });

                const data = await response.json();

                if (!data.success) {
                    alert('Error: ' + data.error);
                    return;
                }

                estadoActual.contenidoActual = data.contenido;
                document.getElementById('contenidoModal').textContent = data.contenido;
                document.getElementById('modalResultados').classList.remove('hidden');

            } catch (error) {
                console.error('Error:', error);
                alert('Error al obtener formato: ' + error.message);
            }
        }

        async function obtenerIngredientes() {
            const personas = parseInt(document.getElementById('personas').value);
            const formato = document.getElementById('formato').value;

            if (isNaN(personas) || personas < 1) {
                alert('Por favor ingresa un n√∫mero v√°lido de personas');
                return;
            }

            mostrarCargando();

            try {
                const response = await fetch('/api/ingredientes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ personas, formato: 'texto' })
                });

                const data = await response.json();

                if (!data.success) {
                    alert('Error: ' + data.error);
                    return;
                }

                estadoActual.ingredientes = data.contenido;
                // Estilo para el contenido de ingredientes
                document.getElementById('contenidoIngredientes').innerHTML = 
                    `<div class="bg-gray-950/50 p-4 rounded-xl border border-white/5 h-full overflow-auto custom-scrollbar">
                        <pre class="whitespace-pre-wrap text-sm font-mono text-gray-300 leading-relaxed">${data.contenido}</pre>
                    </div>`;
                
                cambiarTab('ingredientes');
                document.getElementById('btnDescargar').style.display = 'block';
                document.getElementById('btnCopiar').style.display = 'block';

            } catch (error) {
                console.error('Error:', error);
                alert('Error al obtener ingredientes: ' + error.message);
            }
        }

        async function buscarProductos() {
            const termino = document.getElementById('buscarProducto').value.toLowerCase();

            if (termino.length < 2) {
                document.getElementById('resultadosBusqueda').innerHTML = '';
                return;
            }

            try {
                const response = await fetch('/api/productos-disponibles');
                const data = await response.json();

                if (!data.success) return;

                const resultados = data.productos.filter(p => 
                    p.toLowerCase().includes(termino)
                ).slice(0, 5);

                if (resultados.length === 0) {
                    document.getElementById('resultadosBusqueda').innerHTML = 
                        '<p class="text-gray-500 text-sm px-2">No se encontraron productos</p>';
                    return;
                }

                // Estilos actualizados para resultados de b√∫squeda
                let html = '<div class="space-y-1 bg-gray-800/80 backdrop-blur rounded-lg border border-gray-700 overflow-hidden">';
                for (const producto of resultados) {
                    html += `<button 
                        onclick="buscarProductoEspecifico('${producto.replace(/'/g, "\\'")}')"
                        class="w-full text-left hover:bg-blue-600/20 hover:text-blue-300 p-3 text-sm text-gray-300 transition border-b border-gray-700/50 last:border-0"
                    >
                        ${producto}
                    </button>`;
                }
                html += '</div>';

                document.getElementById('resultadosBusqueda').innerHTML = html;

            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function buscarProductoEspecifico(producto) {
            const personas = parseInt(document.getElementById('personas').value);

            try {
                const response = await fetch('/api/producto', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ personas, producto })
                });

                const data = await response.json();
                if (!data.datos) {
                    alert('Error: ' + data.error);
                    return;
                }

                const datos = data.datos;
                alert(`${datos.producto}\n\nPara ${personas} personas:\n${datos.cantidad} ${datos.unidad}`);

            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            }
        }

        function cambiarTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            
            const tabElement = document.getElementById(`tab-${tabName}`);
            if (tabElement) tabElement.classList.remove('hidden');

            // Actualizar estilos de tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('bg-blue-600', 'text-white', 'shadow-lg');
                    btn.classList.remove('text-gray-400');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white', 'shadow-lg');
                    btn.classList.add('text-gray-400');
                }
            });
        }

        function mostrarCargando() {
            // Estilo actualizado para el contenedor de carga
            document.getElementById('contenidoResultados').innerHTML = 
                '<div class="flex justify-center items-center h-64"><div class="spinner"></div></div>';
                
            document.getElementById('contenidoIngredientes').innerHTML = 
                '<div class="flex justify-center items-center h-64"><div class="spinner"></div></div>';
        }

        function cerrarModal() {
            document.getElementById('modalResultados').classList.add('hidden');
        }

        async function copiarAlPortapapeles() {
            if (!estadoActual.contenidoActual) return;
            let contenido = typeof estadoActual.contenidoActual === 'string' ? estadoActual.contenidoActual : JSON.stringify(estadoActual.contenidoActual, null, 2);
            try {
                await navigator.clipboard.writeText(contenido);
                alert('‚úì Copiado al portapapeles');
            } catch (err) { alert('Error al copiar: ' + err); }
        }

        function copiarContenidoModal() {
            const contenido = document.getElementById('contenidoModal').textContent;
            navigator.clipboard.writeText(contenido).then(() => alert('‚úì Copiado')).catch(err => alert('Error: ' + err));
        }

        async function descargarResultados() { document.getElementById('modalDescarga').classList.remove('hidden'); }
        function cerrarModalDescarga() { document.getElementById('modalDescarga').classList.add('hidden'); }
        function mostrarOpcionesDescarga() { document.getElementById('modalDescarga').classList.remove('hidden'); }

        // Funciones de descarga (Misma l√≥gica, solo UI cambiada en HTML)
        async function descargarPDF() {
            const personas = parseInt(document.getElementById('personas').value);
            try {
                const response = await fetch('/api/descargar/pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ personas })
                });
                if (!response.ok) throw new Error('Error al generar PDF');
                const blob = await response.blob();
                downloadBlob(blob, `food-calculator-${personas}-personas.pdf`);
                cerrarModalDescarga();
            } catch (error) { alert(error.message); }
        }

        async function descargarImagen() {
            const personas = parseInt(document.getElementById('personas').value);
            try {
                const response = await fetch('/api/descargar/imagen', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ personas })
                });
                if (!response.ok) throw new Error('Error al generar imagen');
                const blob = await response.blob();
                downloadBlob(blob, `food-calculator-${personas}-personas.png`);
                cerrarModalDescarga();
            } catch (error) { alert(error.message); }
        }

        function downloadBlob(blob, filename) {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        async function descargarTXT() {
            if (!estadoActual.contenidoActual) return;
            const contenido = typeof estadoActual.contenidoActual === 'string' ? estadoActual.contenidoActual : JSON.stringify(estadoActual.contenidoActual, null, 2);
            const personas = parseInt(document.getElementById('personas').value);
            descargarArchivo(contenido, `food-calculator-${personas}-personas.txt`);
            cerrarModalDescarga();
        }

        function descargarContenidoModal() {
            const contenido = document.getElementById('contenidoModal').textContent;
            descargarArchivo(contenido, 'resultados-food-calc.txt');
        }

        function descargarArchivo(contenido, nombre) {
            const elemento = document.createElement('a');
            elemento.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(contenido));
            elemento.setAttribute('download', nombre);
            elemento.style.display = 'none';
            document.body.appendChild(elemento);
            elemento.click();
            document.body.removeChild(elemento);
        }

        // Funciones para preparaciones
        async function cargarPreparaciones() {
            try {
                const response = await fetch('/api/preparaciones-disponibles');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('preparacion');
                    data.preparaciones.forEach(prep => {
                        const option = document.createElement('option');
                        option.value = prep;
                        option.textContent = prep;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error al cargar preparaciones:', error);
            }
        }

        async function calcularPreparacion() {
            const personas = parseInt(document.getElementById('personas').value);
            const preparacion = document.getElementById('preparacion').value;
            const formato = document.getElementById('formato').value;
            
            if (!preparacion) {
                alert('Por favor selecciona un plato');
                return;
            }
            
            if (isNaN(personas) || personas < 1) {
                alert('Por favor ingresa un n√∫mero v√°lido de personas');
                return;
            }

            mostrarCargando();

            try {
                const response = await fetch('/api/preparacion', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ personas, preparacion, formato })
                });

                const data = await response.json();

                if (!data.success) {
                    alert('Error: ' + data.error);
                    return;
                }

                // Mostrar los resultados de la preparaci√≥n
                let html = `<div class="mb-6 fade-in">
                    <div class="flex justify-between items-end mb-6 border-b border-white/10 pb-4">
                        <div>
                            <h3 class="text-2xl font-bold text-white">
                                üç≥ ${data.preparacion}
                            </h3>
                            <p class="text-sm text-gray-400 mt-1">Para <span class="text-orange-400 font-bold">${data.personas} personas</span></p>
                        </div>
                        <span class="text-xs bg-gray-800 text-gray-400 px-2 py-1 rounded border border-gray-700">Ingredientes</span>
                    </div>`;
                    
                html += '<h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">üìã Ingredientes Necesarios</h4>';
                html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                
                for (const [ingrediente, cantidad] of Object.entries(data.ingredientes)) {
                    // Detectar unidad
                    let unidad = 'kg';
                    if (ingrediente === 'Huevos') unidad = 'unidades';
                    else if (ingrediente.includes('Agua') || ingrediente.includes('Vinagre')) unidad = 'litros';
                    
                    const color = unidad === 'litros' ? 'bg-cyan-900/10 border-cyan-500/20 hover:border-cyan-500/40 text-cyan-400' : 
                                  unidad === 'unidades' ? 'bg-yellow-900/10 border-yellow-500/20 hover:border-yellow-500/40 text-yellow-400' : 
                                  'bg-orange-900/10 border-orange-500/20 hover:border-orange-500/40 text-orange-400';
                    
                    html += `<div class="${color} rounded-xl p-4 flex justify-between items-center transition-all group border">
                        <span class="font-medium text-gray-200 group-hover:text-white">${ingrediente}</span>
                        <span class="font-bold text-lg">${cantidad} <span class="text-sm opacity-70">${unidad}</span></span>
                    </div>`;
                }
                html += '</div></div>';
                document.getElementById('contenidoResultados').innerHTML = html;
                
                // Cambiar a tab de resultados si est√° en otra pesta√±a
                cambiarTab('resultados');
                estadoActual.contenidoActual = data.contenido;
                document.getElementById('btnDescargar').style.display = 'block';
                document.getElementById('btnCopiar').style.display = 'block';
            } catch (error) {
                alert('Error al calcular: ' + error.message);
            }
        }

        async function calcularRefresco() {
            const personas = parseInt(document.getElementById('personas').value);
            
            if (isNaN(personas) || personas < 1) {
                alert('Por favor ingresa un n√∫mero v√°lido de personas');
                return;
            }

            mostrarCargando();

            try {
                const response = await fetch('/api/refresco', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ personas })
                });

                const data = await response.json();

                if (!data.success) {
                    alert('Error: ' + data.error);
                    return;
                }

                // Mostrar los resultados del refresco
                let html = `<div class="mb-6 fade-in">
                    <div class="flex justify-between items-end mb-6 border-b border-white/10 pb-4">
                        <div>
                            <h3 class="text-2xl font-bold text-white">
                                ü•§ Refresco
                            </h3>
                            <p class="text-sm text-gray-400 mt-1">Para <span class="text-cyan-400 font-bold">${data.personas} personas</span></p>
                        </div>
                        <span class="text-xs bg-gray-800 text-gray-400 px-2 py-1 rounded border border-gray-700">8 oz por persona</span>
                    </div>`;
                    
                html += '<div class="grid grid-cols-1 gap-4">';
                html += `<div class="bg-cyan-900/20 border border-cyan-500/40 rounded-xl p-6 flex justify-between items-center transition-all">
                    <div>
                        <p class="text-sm text-cyan-300 uppercase tracking-wider mb-1">Cantidad Total en Litros</p>
                        <p class="text-gray-300">8 oz √ó ${data.personas} personas</p>
                    </div>
                    <span class="font-bold text-4xl text-cyan-400">${data.refresco_litros}<span class="text-lg text-cyan-500/70"> L</span></span>
                </div>`;
                html += `<div class="bg-blue-900/20 border border-blue-500/40 rounded-xl p-6 flex justify-between items-center transition-all">
                    <div>
                        <p class="text-sm text-blue-300 uppercase tracking-wider mb-1">Onzas Totales</p>
                        <p class="text-gray-300">Para referencia</p>
                    </div>
                    <span class="font-bold text-4xl text-blue-400">${data.refresco_onzas}<span class="text-lg text-blue-500/70"> oz</span></span>
                </div>`;
                html += '</div></div>';
                document.getElementById('contenidoResultados').innerHTML = html;
                
                // Cambiar a tab de resultados
                cambiarTab('resultados');
                estadoActual.contenidoActual = `Refresco para ${personas} personas:\n- ${data.refresco_litros} litros\n- ${data.refresco_onzas} onzas`;
                document.getElementById('btnDescargar').style.display = 'block';
                document.getElementById('btnCopiar').style.display = 'block';
            } catch (error) {
                alert('Error al calcular: ' + error.message);
            }
        }

        // Inicializar Tab Default y cargar preparaciones
        cambiarTab('resultados');
        cargarPreparaciones();
    </script>
</body>
</html>